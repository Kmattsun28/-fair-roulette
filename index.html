<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* èƒŒæ™¯è‰² */
            display: flex;
            justify-content: center; /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã‚’æ°´å¹³æ–¹å‘ã®ä¸­å¤®ã«é…ç½® */
            align-items: center;    /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã«é…ç½® */
            min-height: 100vh;      /* ãƒšãƒ¼ã‚¸ã®æœ€å°é«˜ã•ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã«è¨­å®š */
            margin: 0;
            padding: 20px;          /* å…¨ä½“çš„ãªãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        }
        canvas {
            background-color: #ffffff; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯è‰² */
            border: 4px solid #cbd5e1; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ ç·š */
            border-radius: 9999px; /* å††å½¢ã«ã™ã‚‹ */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* å½± */
            display: block;
            touch-action: none; /* ã‚¿ãƒƒãƒæ“ä½œã‚’ç„¡åŠ¹ã«ã™ã‚‹ */
        }
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            @apply px-8 py-4 rounded-full font-bold transition-all duration-300 ease-in-out shadow-xl transform;
            /* ã‚ˆã‚Šè¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
            @apply hover:scale-105 active:scale-95 focus:outline-none focus:ring-4 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-400 hover:bg-gray-500 text-gray-900 focus:ring-gray-300;
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« (ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨) */
        .message-box {
            @apply fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50;
        }
        .message-content {
            @apply bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm w-full;
        }
        .message-content h3 {
            @apply text-2xl font-bold mb-4 text-gray-800;
        }
        .message-content p {
            @apply text-lg text-gray-700 mb-6;
        }
        .message-content button {
            @apply btn btn-primary;
        }
        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .segment-input-field {
            @apply w-full p-3 border border-gray-300 rounded-md mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400;
        }
        /* é …ç›®è¿½åŠ /å‰Šé™¤ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
        .btn-small {
            @apply px-4 py-2 text-sm rounded-full font-bold transition-all duration-300 ease-in-out shadow-md transform;
            @apply hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­å®šãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .segment-settings-box {
            @apply p-4 bg-white rounded-lg shadow-md w-full max-w-md mt-8;
        }

        /* ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
        .app-container {
            display: flex;
            flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
            align-items: center; /* å­è¦ç´ ã‚’æ°´å¹³æ–¹å‘ã®ä¸­å¤®ã«é…ç½® */
            max-width: 600px; /* ã‚¢ãƒ—ãƒªå…¨ä½“ã®æœ€å¤§å¹… */
            width: 100%; /* è¦ªã®åˆ©ç”¨å¯èƒ½ãªå¹…ã‚’å ã‚ã‚‹ */
            padding: 20px; /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            box-sizing: border-box; /* paddingã‚’width/heightã«å«ã‚ã‚‹ */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ é¸æŠãƒªã‚¹ãƒˆã®é …ç›®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-select-option {
            @apply flex items-center p-1 rounded-md cursor-pointer transition-colors duration-100;
        }
        .custom-select-option:hover {
            @apply bg-blue-100;
        }
        .custom-select-option.selected {
            @apply bg-blue-200;
        }
        /* éæ´»æ€§æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .disabled-overlay {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200">
    <!-- ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="app-container">
        <h1 id="rouletteTitle" class="text-4xl font-extrabold text-gray-800 mb-8 text-center drop-shadow-md cursor-pointer select-none">ã‚¦ã‚§ãƒ–ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
        <div class="relative mb-8">
            <canvas id="rouletteCanvas"></canvas>
            <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é‡ -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-[100%] -mt-2 w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-b-[30px] border-b-red-600 z-10"></div>
        </div>
        <div class="flex space-x-4 mb-6">
            <button id="showSecretButton" class="btn btn-secondary btn-small" style="background-color: #bfdbfe; color: #bfdbfe; border: none; min-width: 40px; min-height: 40px; padding: 0;">â—</button>
            <button id="spinButton" class="btn btn-primary">å›ã™</button>
            <button id="resetButton" class="btn btn-secondary">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="rouletteResultDisplay" class="text-3xl font-extrabold text-blue-700 mt-4 mb-6 text-center">
            <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>

        <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å†…å®¹è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ä¸‹ã«é…ç½®) -->
        <div class="segment-settings-box">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å†…å®¹ã‚’è¨­å®š</h2>
            
            <!-- ç§˜å¯†ã®ãƒœã‚¿ãƒ³ã¨å½“ãŸã‚‹é …ç›®é¸æŠ (åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º) -->
            <div id="secretControlsContainer" class="mb-4 flex items-center justify-between hidden">
                <button id="toggleSecretModeButton" class="text-sm text-gray-500 hover:text-blue-600">Special Mode: OFF</button>
                <div class="flex items-center space-x-2">
                    <label class="text-gray-700 text-sm whitespace-nowrap">å½“ãŸã‚‹é …ç›®:</label>
                    <!-- selectã‚¿ã‚°ã‚’divã«å¤‰æ›´ã—ã€ã‚«ã‚¹ã‚¿ãƒ ã®é¸æŠãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰ -->
                    <div id="winningSegmentsOptionsContainer" class="p-2 border border-gray-300 rounded-md text-sm overflow-y-auto" style="max-height: 150px; flex-grow: 1;">
                        <!-- JavaScriptã«ã‚ˆã£ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>

            <div id="segmentInputsContainer" class="w-full">
                <!-- ã“ã“ã«é …ç›®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <div class="flex space-x-2 mt-2 w-full justify-center">
                <button id="addSegmentButton" class="btn btn-secondary btn-small">é …ç›®ã‚’è¿½åŠ </button>
                <button id="removeSegmentButton" class="btn btn-secondary btn-small">æœ€å¾Œã®é …ç›®ã‚’å‰Šé™¤</button>
            </div>
            <button id="applySegmentsButton" class="btn btn-primary w-full mt-4">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é©ç”¨</button>
            <p class="text-sm text-gray-600 mt-2 text-center">å„é …ç›®ã‚’ä¸€è¡Œãšã¤å…¥åŠ›ã—ã€ã€Œã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é©ç”¨ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ (ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã¨ã—ã¦æ®‹ã™) -->
    <div id="messageBox" class="message-box hidden">
        <div class="message-content">
            <h3 id="messageTitle"></h3>
            <p id="messageText"></p>
            <button id="messageCloseButton">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦åˆ©ç”¨å¯èƒ½ãªã‚¢ãƒ—ãƒªIDã¨Firebaseè¨­å®šã‚’å®šç¾© (ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ãŒã€å¿…é ˆã§ã™)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const spinButton = document.getElementById('spinButton');
        const resetButton = document.getElementById('resetButton');
        const messageBox = document.getElementById('messageBox'); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const messageCloseButton = document.getElementById('messageCloseButton');
        // æ–°ã—ã„è¦ç´ ã¸ã®å‚ç…§
        const rouletteResultDisplay = document.getElementById('rouletteResultDisplay'); // çµæœè¡¨ç¤ºç”¨ã®æ–°ã—ã„è¦ç´ 
        const segmentInputsContainer = document.getElementById('segmentInputsContainer');
        const addSegmentButton = document.getElementById('addSegmentButton');
        const removeSegmentButton = document.getElementById('removeSegmentButton');
        const applySegmentsButton = document.getElementById('applySegmentsButton');
        const toggleSecretModeButton = document.getElementById('toggleSecretModeButton'); // ç§˜å¯†ã®ãƒœã‚¿ãƒ³
        const showSecretButton = document.getElementById('showSecretButton');
        // è¤‡æ•°é¸æŠã®ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ã¸ã®å‚ç…§
        const winningSegmentsOptionsContainer = document.getElementById('winningSegmentsOptionsContainer'); 
        const rouletteTitle = document.getElementById('rouletteTitle'); // ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ 

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å®šç¾© (åˆæœŸå€¤ - ã“ã‚Œã‚‰ã¯é …ç›®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸè¡¨ç¤ºã«ä½¿ã‚ã‚Œã¾ã™)
        const initialSegmentTexts = [
            'å½“é¸!', 'å¤–ã‚Œ', 'å†æŒ‘æˆ¦', 'æƒœã—ã„!',
            'ã‚‚ã†ä¸€å›!', 'æ®‹å¿µ', 'å¤§å½“ãŸã‚Š!', 'æŒ‘æˆ¦è€…'
        ];
        let segments = []; // å®Ÿéš›ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯`applySegments`ã§æ›´æ–°ã•ã‚Œã‚‹

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«é©ç”¨ã™ã‚‹è‰²ã®ã‚µã‚¤ã‚¯ãƒ«
        const segmentColors = [
            '#FF6347', '#FFD700', '#6A5ACD', '#3CB371',
            '#FFA07A', '#BA55D3', '#4682B4', '#9ACD32',
            '#FF69B4', '#ADD8E6', '#FF8C00', '#F08080',
            '#87CEEB', '#DDA0DD', '#98FB98', '#FFC0CB'
        ];

        let numSegments = 0; // åˆæœŸã¯0ã€`applySegments`ã§æ›´æ–°
        let startAngleRad = 0; // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é–‹å§‹è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
        let initialStartAngleOnSpinRad = 0; // ã‚¹ãƒ”ãƒ³é–‹å§‹æ™‚ã®è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
        let arc = 0; // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
        let spinTime = 0; // ã‚¹ãƒ”ãƒ³æ™‚é–“
        let spinTimeTotal = 0; // ã‚¹ãƒ”ãƒ³ç·æ™‚é–“
        let spinAngleTotalRad = 0; // ã‚¹ãƒ”ãƒ³ç·å›è»¢é‡ (ãƒ©ã‚¸ã‚¢ãƒ³)

        let spinTimeout = null; // ã‚¹ãƒ”ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆID

        let isSpecialModeActive = false; // ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°
        // è¤‡æ•°é¸æŠã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€é¸æŠã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é…åˆ—ã§ä¿æŒ
        let selectedWinningSegmentIndices = []; 

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨)
        function showMessageBox(title, message) {
            messageTitle.textContent = title;
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        messageCloseButton.addEventListener('click', hideMessageBox);

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹é–¢æ•°
        function resizeCanvas() {
            const size = Math.min(window.innerWidth * 0.8, window.innerHeight * 0.6, 500); // æœ€å¤§500px
            canvas.width = size;
            canvas.height = size;
            drawRouletteWheel(); // ã‚µã‚¤ã‚ºå¤‰æ›´å¾Œã«å†æç”»
        }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®æç”»é–¢æ•°
        function drawRouletteWheel() {
            if (!ctx) {
                console.error("Canvas context is not available.");
                return;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.9; // åŠå¾„

            ctx.strokeStyle = '#374151'; // æ ç·šã®è‰²
            ctx.lineWidth = 3; // æ ç·šã®å¤ªã•

            // arcã‚’å†è¨ˆç®—ã™ã‚‹
            numSegments = segments.length;
            if (numSegments === 0) { // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆã¯æç”»ã—ãªã„
                return;
            }
            arc = (2 * Math.PI) / numSegments; // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®è§’åº¦ã‚’æ­£ç¢ºã«è¨ˆç®—

            for (let i = 0; i < numSegments; i++) {
                const angle = startAngleRad + i * arc; // startAngleRadãŒãƒ©ã‚¸ã‚¢ãƒ³ãªã®ã§ãã®ã¾ã¾ä½¿ç”¨
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, angle, angle + arc, false);
                ctx.lineTo(centerX, centerY);
                ctx.closePath();
                ctx.fillStyle = segments[i].color; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®è‰²
                ctx.fill();
                ctx.stroke(); // æ ç·šã‚’æç”»

                ctx.save();
                ctx.translate(centerX, centerY); // åŸç‚¹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸­å¿ƒã«ç§»å‹•
                // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å¢ƒç•Œç·šã«æ²¿ã£ã¦æ°´å¹³ã«è¡¨ç¤ºã•ã›ã‚‹ãŸã‚ã®å›è»¢ã¨é…ç½®
                // è§’åº¦ã®ä¸­å¿ƒã«åˆã‚ã›ã€ã•ã‚‰ã«90åº¦å›è»¢ã•ã›ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’æ°´å¹³ã«ã€‚
                ctx.rotate(angle + arc / 2 + Math.PI / 2); 
                ctx.textAlign = 'center'; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆã«
                ctx.fillStyle = '#FFFFFF'; // ãƒ†ã‚­ã‚¹ãƒˆã®è‰²
                ctx.font = `${Math.min(radius * 0.07, 24)}px Inter, sans-serif`; // ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€æœ€å¤§24px
                // Xã¯0ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ä¸­å¿ƒã€Yã¯è² ã®å€¤ã§ä¸­å¿ƒã‹ã‚‰å¤–å´ã¸é…ç½®
                ctx.fillText(segments[i].text, 0, -radius * 0.65); 
                ctx.restore();
            }

            // ä¸­å¤®ã®å††ã‚’æç”»
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.15, 0, 2 * Math.PI, false);
            ctx.fillStyle = '#10B981'; // ä¸­å¤®ã®å††ã®è‰²
            ctx.fill();
            ctx.strokeStyle = '#047857';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // æ…£æ€§çš„ãªã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        // t: ç¾åœ¨ã®æ™‚é–“ (0ã‹ã‚‰dã¾ã§)
        // b: é–‹å§‹å€¤ (ã“ã“ã§ã¯å¸¸ã«0)
        // c: å¤‰åŒ–é‡ (ã“ã“ã§ã¯ spinAngleTotalRad)
        // d: ç·æ™‚é–“ (spinTimeTotal)
        function easeOut(t, b, c, d) {
            let ts = (t /= d) * t;
            let tc = ts * t;
            return b + c * (tc + -3 * ts + 3 * t);
        }

        // ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function rotateWheel() {
            spinTime += 30; // 30msã”ã¨ã«æ›´æ–°
            if (spinTime >= spinTimeTotal) {
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®æœ€çµ‚è§’åº¦ã‚’è¨­å®š
                startAngleRad = initialStartAngleOnSpinRad + spinAngleTotalRad;
                // è§’åº¦ã‚’0ã‹ã‚‰2PIã®ç¯„å›²ã«æ­£è¦åŒ–
                startAngleRad = (startAngleRad % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
                drawRouletteWheel(); // æœ€çµ‚è§’åº¦ã§å†æç”»
                stopRotateWheel(); // ã‚¹ãƒ”ãƒ³çµ‚äº†å‡¦ç†
                return;
            }
            const easedProgressAngleRad = easeOut(spinTime, 0, spinAngleTotalRad, spinTimeTotal);
            // ç¾åœ¨ã®startAngleRadã¯ã€ã‚¹ãƒ”ãƒ³é–‹å§‹æ™‚ã®è§’åº¦ + çµŒéã—ãŸè§’åº¦å¤‰åŒ–
            startAngleRad = initialStartAngleOnSpinRad + easedProgressAngleRad;
            drawRouletteWheel(); // å†æç”»
            spinTimeout = requestAnimationFrame(rotateWheel); // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¦æ±‚
        }

        // ã‚¹ãƒ”ãƒ³åœæ­¢å‡¦ç†
        function stopRotateWheel() {
            cancelAnimationFrame(spinTimeout); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
            spinTimeout = null;

            let winningSegmentIndex;

            // é‡ãŒæŒ‡ã—ã¦ã„ã‚‹å®Ÿéš›ã®è§’åº¦ã‚’è¨ˆç®—
            const needleReferenceAngleRad = 3 * Math.PI / 2; // é‡ã®è§’åº¦ (ä¸Šæ–¹å‘)
            const normalizedStartAngle = (startAngleRad % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
            let angleUnderNeedle = (needleReferenceAngleRad - normalizedStartAngle + 2 * Math.PI) % (2 * Math.PI);
            winningSegmentIndex = Math.floor(angleUnderNeedle / arc);
            
            // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®èª¿æ•´
            winningSegmentIndex = Math.min(winningSegmentIndex, numSegments - 1);
            if (winningSegmentIndex < 0) winningSegmentIndex = 0;


            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒç©ºã®å ´åˆã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (segments.length === 0) {
                showMessageBox('ã‚¨ãƒ©ãƒ¼', 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                spinButton.disabled = false;
                resetButton.disabled = false;
                return;
            }

            const winningSegment = segments[winningSegmentIndex];
            // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã«ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            rouletteResultDisplay.textContent = `ã€Œ${winningSegment.text}ã€ãŒå‡ºã¾ã—ãŸï¼`;
            
            spinButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹
            resetButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹ã«ã™ã‚‹
            applySegmentsButton.disabled = false; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé©ç”¨ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            winningSegmentsOptionsContainer.classList.remove('disabled-overlay'); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’å›ã™é–¢æ•°
        function spin() {
            if (segments.length === 0) {
                showMessageBox('ã‚¨ãƒ©ãƒ¼', 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            spinButton.disabled = true; // ã‚¹ãƒ”ãƒ³ä¸­ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹ã«ã™ã‚‹
            resetButton.disabled = true; // ã‚¹ãƒ”ãƒ³ä¸­ã¯ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹ã«ã™ã‚‹
            applySegmentsButton.disabled = true; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé©ç”¨ãƒœã‚¿ãƒ³ã‚‚ç„¡åŠ¹ã«ã™ã‚‹
            winningSegmentsOptionsContainer.classList.add('disabled-overlay'); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç„¡åŠ¹ã«ã™ã‚‹

            // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            rouletteResultDisplay.textContent = ''; 

            spinTime = 0;
            initialStartAngleOnSpinRad = startAngleRad; // ã‚¹ãƒ”ãƒ³é–‹å§‹æ™‚ã®è§’åº¦ã‚’ä¿å­˜ (ãƒ©ã‚¸ã‚¢ãƒ³)
            arc = (2 * Math.PI) / segments.length; // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®è§’åº¦ (ãƒ©ã‚¸ã‚¢ãƒ³)
            
            // ä¸¡ãƒ¢ãƒ¼ãƒ‰ã§å…±æœ‰ã•ã‚Œã‚‹å›è»¢æ•°ã®ç¯„å›²ã‚’å®šç¾©
            const minFullRotations = 15; // æœ€ä½å›è»¢æ•°
            const maxFullRotations = 20; // æœ€å¤§å›è»¢æ•°
            
            // ä¸¡ãƒ¢ãƒ¼ãƒ‰ã§å…±æœ‰ã•ã‚Œã‚‹ãƒ©ãƒ³ãƒ€ãƒ ãªå®Ÿå›è»¢æ•° (æ•´æ•° + 0-1å›è»¢ã®è¿½åŠ )
            const randomFullRotations = Math.floor(Math.random() * (maxFullRotations - minFullRotations + 1)) + minFullRotations;
            const randomFractionalRotation = Math.random() * 2 * Math.PI;

            // ä¸¡ãƒ¢ãƒ¼ãƒ‰ã§å…±æœ‰ã•ã‚Œã‚‹ã‚¹ãƒ”ãƒ³æ™‚é–“ã‚’æ±ºå®š
            spinTimeTotal = 5000 + Math.random() * 3000; // 5ç§’ã€œ8ç§’

            if (isSpecialModeActive) {
                // ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã€ã‹ã¤é¸æŠé …ç›®ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                if (selectedWinningSegmentIndices.length === 0) {
                    showMessageBox('ã‚¨ãƒ©ãƒ¼', 'ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å½“ãŸã‚‹é …ç›®ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                    spinButton.disabled = false;
                    resetButton.disabled = false;
                    applySegmentsButton.disabled = false;
                    winningSegmentsOptionsContainer.classList.remove('disabled-overlay');
                    return;
                }

                // é¸æŠã•ã‚ŒãŸé …ç›®ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ã‚’é¸ã¶
                const randomIndex = Math.floor(Math.random() * selectedWinningSegmentIndices.length);
                const actualWinningIndex = selectedWinningSegmentIndices[randomIndex];
                
                // é‡ãŒæŒ‡ã™ç›®æ¨™è§’åº¦ï¼ˆä¸Šæ–¹å‘ã¯ 3*PI/2 ãƒ©ã‚¸ã‚¢ãƒ³ï¼‰
                const needleTargetAngleRad = 3 * Math.PI / 2;
                
                // å½“é¸ã•ã›ãŸã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ä¸­å¿ƒãŒæœ€çµ‚çš„ã«ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«æ¥ã‚‹ã¹ããƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸Šã®è§’åº¦
                const winningSegmentCenterRelativeAngle = actualWinningIndex * arc + arc / 2;

                // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®æœ€çµ‚çš„ãª startAngleRad ãŒå–ã‚‹ã¹ãç†æƒ³çš„ãªå€¤
                let desiredFinalStartAngleRad = needleTargetAngleRad - winningSegmentCenterRelativeAngle;

                // è‡ªç„¶ãªåœæ­¢ä½ç½®ã®ãŸã‚ã®ãƒ©ãƒ³ãƒ€ãƒ ãªã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
                const randomOffset = (Math.random() * arc * 0.5) - (arc * 0.25); 
                desiredFinalStartAngleRad += randomOffset;

                // è§’åº¦ã‚’0ã‹ã‚‰2PIã®ç¯„å›²ã«æ­£è¦åŒ–
                desiredFinalStartAngleRad = (desiredFinalStartAngleRad % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);

                // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã® startAngleRad ã‚’æ­£è¦åŒ– (ã‚¹ãƒ”ãƒ³é–‹å§‹å‰ã®è§’åº¦)
                const currentStartAngleNormalizedRad = (initialStartAngleOnSpinRad % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
                
                // ç›®æ¨™ã® final_start_angle ã«åˆ°é”ã™ã‚‹ãŸã‚ã«å¿…è¦ãªè¿½åŠ ã®å›è»¢é‡ (ãƒ©ã‚¸ã‚¢ãƒ³)
                let angleToReachTarget = desiredFinalStartAngleRad - currentStartAngleNormalizedRad;

                // æ™‚è¨ˆå›ã‚Šã«å›è»¢ã•ã›ã‚‹ãŸã‚ã€è² ã®å ´åˆã¯2PIã‚’è¿½åŠ 
                if (angleToReachTarget < 0) {
                    angleToReachTarget += 2 * Math.PI;
                }

                // ç·å›è»¢è§’åº¦ã‚’è¨ˆç®— (ãƒ©ã‚¸ã‚¢ãƒ³)
                // ã“ã“ã§ã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ•ãƒ«å›è»¢æ•°ã‚’åŠ ãˆã¦ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜å›è»¢é‡ã«ã™ã‚‹
                spinAngleTotalRad = angleToReachTarget + (randomFullRotations * 2 * Math.PI);

            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®ç·å›è»¢è§’åº¦ã‚’è¨ˆç®—
                // ã“ã“ã§ã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ•ãƒ«å›è»¢æ•°ã¨ãƒ©ãƒ³ãƒ€ãƒ ãªå°æ•°å›è»¢æ•°ã‚’åˆã‚ã›ã¦ã€ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜å›è»¢é‡ã«ã™ã‚‹
                spinAngleTotalRad = randomFullRotations * 2 * Math.PI + randomFractionalRotation;
            }
            
            rotateWheel(); // ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetWheel() {
            cancelAnimationFrame(spinTimeout);
            spinTimeout = null;
            startAngleRad = 0; // é–‹å§‹è§’åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            drawRouletteWheel(); // å†æç”»
            spinButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            resetButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            applySegmentsButton.disabled = false; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé©ç”¨ãƒœã‚¿ãƒ³ã‚‚æœ‰åŠ¹ã«ã™ã‚‹
            winningSegmentsOptionsContainer.classList.remove('disabled-overlay'); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            hideMessageBox(); // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’éš ã™
            rouletteResultDisplay.textContent = ''; // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
        }

        // é …ç›®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addSegmentInput(value = '', placeholder = 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé …ç›®') {
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'flex items-center mb-2 w-full';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = placeholder;
            input.value = value;
            input.className = 'segment-input-field flex-grow'; // flex-growã§å¹…ã‚’åºƒã’ã‚‹

            inputWrapper.appendChild(input);
            segmentInputsContainer.appendChild(inputWrapper);
            // æ–°ã—ã„è¦ç´ ãŒè¿½åŠ ã•ã‚ŒãŸã‚‰ã€ãã®è¦ç´ ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†è¡¨ç¤ºé ˜åŸŸã‚’èª¿æ•´ã™ã‚‹
            input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // æœ€å¾Œã®é …ç›®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function removeLastSegmentInput() {
            // å°‘ãªãã¨ã‚‚1ã¤ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ®‹ã™
            if (segmentInputsContainer.children.length > 1) {
                segmentInputsContainer.removeChild(segmentInputsContainer.lastChild);
                // é …ç›®ãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å†é©ç”¨ã—ã¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                applySegments(); 
            } else {
                showMessageBox('é …ç›®å‰Šé™¤ã‚¨ãƒ©ãƒ¼', 'å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé …ç›®ãŒå¿…è¦ã§ã™ã€‚');
            }
        }

        // å½“ãŸã‚‹é …ç›®é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (ã‚«ã‚¹ã‚¿ãƒ UIç”¨)
        function populateWinningSegmentsOptions() {
            winningSegmentsOptionsContainer.innerHTML = ''; // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            segments.forEach((segment, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'custom-select-option';
                optionDiv.dataset.index = index; // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'mr-2';
                checkbox.checked = selectedWinningSegmentIndices.includes(index); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 

                const textSpan = document.createElement('span');
                textSpan.textContent = segment.text;

                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(textSpan);

                // åˆæœŸé¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                if (checkbox.checked) {
                    optionDiv.classList.add('selected'); // Tailwindã®`bg-blue-200`ã‚’é©ç”¨ã™ã‚‹CSSã‚¯ãƒ©ã‚¹
                }

                winningSegmentsOptionsContainer.appendChild(optionDiv);
            });

            // ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            updateSecretModeButtonText();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«åŸºã¥ã„ã¦ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function applySegments() {
            const newSegmentTexts = [];
            // segmentInputsContainerã®å­è¦ç´ ã‹ã‚‰ç›´æ¥ input ã‚’æ¤œç´¢
            const inputElements = segmentInputsContainer.querySelectorAll('input[type="text"]');
            
            // å„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å€¤ã‚’åé›†
            inputElements.forEach((input) => {
                const text = input.value.trim();
                if (text !== '') {
                    newSegmentTexts.push(text);
                }
            });

            if (newSegmentTexts.length === 0) {
                showMessageBox('å…¥åŠ›ã‚¨ãƒ©ãƒ¼', 'æœ‰åŠ¹ãªãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å°‘ãªãã¨ã‚‚1ã¤ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                spinButton.disabled = true;
                return;
            }

            // æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’ä½œæˆã—ã€è‰²ã‚’å¾ªç’°ã—ã¦å‰²ã‚Šå½“ã¦ã‚‹
            segments = newSegmentTexts.map((text, index) => ({
                color: segmentColors[index % segmentColors.length],
                text: text
            }));
            
            // æ–°ã—ã„é …ç›®ãŒé©ç”¨ã•ã‚ŒãŸã‚‰ã€ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é–‹å§‹è§’åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            startAngleRad = 0; 

            // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’å†æç”»
            drawRouletteWheel();
            
            // å½“ãŸã‚‹é …ç›®é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°
            populateWinningSegmentsOptions();

            // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒå›ã›ã‚‹çŠ¶æ…‹ã«æˆ»ã™
            spinButton.disabled = false;
            resetButton.disabled = false;
            rouletteResultDisplay.textContent = ''; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé©ç”¨æ™‚ã«çµæœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        }

        // åˆæœŸé …ç›®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º
        function initializeSegmentInputs() {
            segmentInputsContainer.innerHTML = ''; // æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            if (initialSegmentTexts.length > 0) {
                initialSegmentTexts.forEach(text => {
                    addSegmentInput(text);
                });
                // åˆæœŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã«é©ç”¨ã—ã¦è¡¨ç¤º
                applySegments();
            } else {
                // åˆæœŸé …ç›®ãŒãªã„å ´åˆã§ã‚‚æœ€ä½1ã¤ã¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
                addSegmentInput('é …ç›®1'); // ä¾‹ãˆã°æœ€åˆã®é …ç›®
                applySegments(); // é …ç›®1ã‚’è¿½åŠ ã—ãŸã‚‰é©ç”¨ã™ã‚‹
            }
        }

        // ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function updateSecretModeButtonText() {
            if (isSpecialModeActive) {
                const selectedCount = selectedWinningSegmentIndices.length;
                if (selectedCount === 0) {
                    toggleSecretModeButton.textContent = `Special Mode: ON (å½“ãŸã‚‹é …ç›®: é¸æŠãªã—)`;
                } else if (selectedCount === 1) {
                    const winningText = segments[selectedWinningSegmentIndices[0]] ? segments[selectedWinningSegmentIndices[0]].text : 'ãªã—';
                    toggleSecretModeButton.textContent = `Special Mode: ON (å½“ãŸã‚‹é …ç›®: ${winningText})`;
                } else {
                    toggleSecretModeButton.textContent = `Special Mode: ON (å½“ãŸã‚‹é …ç›®: ${selectedCount}é …ç›®é¸æŠä¸­)`;
                }
                toggleSecretModeButton.classList.remove('text-gray-500');
                toggleSecretModeButton.classList.add('text-green-600', 'font-bold');
            } else {
                toggleSecretModeButton.textContent = "Special Mode: OFF";
                toggleSecretModeButton.classList.remove('text-green-600', 'font-bold');
                toggleSecretModeButton.classList.add('text-gray-500');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        spinButton.addEventListener('click', spin);
        resetButton.addEventListener('click', resetWheel);
        applySegmentsButton.addEventListener('click', applySegments); // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé©ç”¨ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        addSegmentButton.addEventListener('click', () => addSegmentInput()); // é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        removeSegmentButton.addEventListener('click', removeLastSegmentInput); // æœ€å¾Œã®é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('resize', resizeCanvas); // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«å†æç”»

        // showSecretButtonã‚¯ãƒªãƒƒã‚¯ã§ç§˜å¯†ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ãƒˆã‚°ãƒ«
        showSecretButton.addEventListener('click', () => {
            secretControlsContainer.classList.toggle('hidden');
        });

        // ç§˜å¯†ã®ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        toggleSecretModeButton.addEventListener('click', () => {
            isSpecialModeActive = !isSpecialModeActive;
            updateSecretModeButtonText(); // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            if (isSpecialModeActive) {
                // showMessageBox('ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–', `ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚æ¬¡ã‹ã‚‰ã¯é¸æŠã•ã‚ŒãŸé …ç›®ã®ä¸­ã‹ã‚‰å½“é¸ã—ã¾ã™ã€‚`);
            } else {
                // showMessageBox('ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹åŒ–', 'ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚');
            }
        });

        // å½“ãŸã‚‹é …ç›®é¸æŠãƒªã‚¹ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚«ã‚¹ã‚¿ãƒ UIç”¨)
        winningSegmentsOptionsContainer.addEventListener('click', (event) => {
            const clickedOptionDiv = event.target.closest('.custom-select-option');
            if (!clickedOptionDiv) return; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ç´ ä»¥å¤–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„

            const index = parseInt(clickedOptionDiv.dataset.index);
            const checkbox = clickedOptionDiv.querySelector('input[type="checkbox"]');

            // é¸æŠçŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«
            if (selectedWinningSegmentIndices.includes(index)) {
                // é¸æŠè§£é™¤
                selectedWinningSegmentIndices = selectedWinningSegmentIndices.filter(i => i !== index);
                checkbox.checked = false;
                clickedOptionDiv.classList.remove('selected');
            } else {
                // é¸æŠ
                selectedWinningSegmentIndices.push(index);
                checkbox.checked = true;
                clickedOptionDiv.classList.add('selected');
            }
            updateSecretModeButtonText(); // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’æç”»ã—ã€ã‚µã‚¤ã‚ºèª¿æ•´
        window.onload = function() {
            resizeCanvas();
            initializeSegmentInputs(); // åˆæœŸé …ç›®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®š
        };
    </script>
</body>
</html>
